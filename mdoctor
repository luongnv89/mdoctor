#!/usr/bin/env bash
#
# mdoctor - Unified macOS Doctor CLI
#
# A single entry-point for checking, cleaning, fixing, and diagnosing macOS.
#
# Usage:
#   mdoctor <command> [options]
#
# Commands:
#   check      Run system health audit (read-only)
#   clean      Run system cleanup (dry-run by default)
#   fix        Apply common fixes
#   info       Show system information summary
#   list       List all modules with category & risk
#   history    View health score trends over time
#   benchmark  Run disk, network, CPU benchmarks
#   version    Show mdoctor version
#   help       Show this help message
#

set -uo pipefail

########################################
# VERSION
########################################

MDOCTOR_VERSION="2.0.0"

# Append short git commit hash if inside a git repo
_mdoctor_commit=""
if command -v git >/dev/null 2>&1; then
  _mdoctor_commit="$(git -C "$(dirname "$0")" rev-parse --short HEAD 2>/dev/null || true)"
fi
if [ -n "$_mdoctor_commit" ]; then
  MDOCTOR_VERSION_FULL="${MDOCTOR_VERSION}+${_mdoctor_commit}"
else
  MDOCTOR_VERSION_FULL="${MDOCTOR_VERSION}"
fi

########################################
# RESOLVE INSTALL DIRECTORY
########################################

# Find the real script directory (handles symlinks)
resolve_script_dir() {
  local resolved
  # Try realpath first (available on modern macOS)
  if resolved="$(realpath "$0" 2>/dev/null)"; then
    dirname "$resolved"
    return
  fi
  # Try perl as fallback (always available on macOS)
  if resolved="$(perl -e 'use Cwd "abs_path"; use File::Basename; print dirname(abs_path($ARGV[0])) . "\n"' "$0" 2>/dev/null)"; then
    echo "$resolved"
    return
  fi
  # Last resort: use known install location or script dir
  if [ -d "${HOME}/.mdoctor/lib" ]; then
    echo "${HOME}/.mdoctor"
  else
    cd -P "$(dirname "$0")" && pwd
  fi
}

MDOCTOR_DIR="$(resolve_script_dir)"

########################################
# COLORS
########################################

if command -v tput >/dev/null 2>&1 && [ -t 1 ]; then
  RED="$(tput setaf 1)"
  GREEN="$(tput setaf 2)"
  YELLOW="$(tput setaf 3)"
  BLUE="$(tput setaf 4)"
  CYAN="$(tput setaf 6)"
  BOLD="$(tput bold)"
  DIM="$(tput dim)"
  RESET="$(tput sgr0)"
else
  # shellcheck disable=SC2034
  RED="" GREEN="" YELLOW="" BLUE="" CYAN="" BOLD="" DIM="" RESET=""
fi

########################################
# HELPERS
########################################

banner() {
  echo "${BOLD}${CYAN}"
  echo '  __  __ ____             _             '
  echo ' |  \/  |  _ \  ___   ___| |_ ___  _ __ '
  echo ' | |\/| | | | |/ _ \ / __| __/ _ \| '\''__|'
  echo ' | |  | | |_| | (_) | (__| || (_) | |   '
  echo ' |_|  |_|____/ \___/ \___|\__\___/|_|   '
  echo "${RESET}"
  echo "${DIM}  macOS Doctor v${MDOCTOR_VERSION_FULL} - Keep your Mac healthy${RESET}"
  echo
}

error() {
  echo "${RED}Error:${RESET} $*" >&2
}

########################################
# COMMAND: check
########################################

cmd_check() {
  local module=""
  local json_flag=false

  while [[ $# -gt 0 ]]; do
    case "$1" in
      --module|-m)
        module="$2"
        shift 2
        ;;
      --json)
        json_flag=true
        shift
        ;;
      --help|-h)
        echo "Usage: mdoctor check [options]"
        echo
        echo "Run system health audit (read-only, changes nothing)."
        echo
        echo "Options:"
        echo "  -m, --module <name>   Run only a specific check module"
        echo "  --json                Output results as JSON"
        echo "  -h, --help            Show this help"
        echo
        echo "Check modules (all [SAFE] read-only):"
        echo "  Hardware:  battery, hardware, bluetooth, usb"
        echo "  System:    system, disk, updates, security, startup, network, performance, storage"
        echo "  Software:  homebrew, node, python, devtools, shell, apps, git_config, containers"
        return 0
        ;;
      *)
        error "Unknown option: $1"
        echo "Run 'mdoctor check --help' for usage."
        return 1
        ;;
    esac
  done

  if [ "$json_flag" = true ]; then
    export JSON_ENABLED=true
  fi

  echo "${DIM}mdoctor v${MDOCTOR_VERSION_FULL}${RESET}"

  if [ -n "$module" ]; then
    # Run a single check module
    local check_file="${MDOCTOR_DIR}/checks/${module}.sh"
    if [ ! -f "$check_file" ]; then
      error "Unknown check module: ${module}"
      echo "Available modules: battery, hardware, bluetooth, usb,"
      echo "  system, disk, updates, security, startup, network, performance, storage,"
      echo "  homebrew, node, python, devtools, shell, apps, git_config, containers"
      return 1
    fi

    # Source libraries
    source "${MDOCTOR_DIR}/lib/common.sh"
    source "${MDOCTOR_DIR}/lib/logging.sh"
    source "${MDOCTOR_DIR}/lib/disk.sh"
    source "${MDOCTOR_DIR}/lib/json.sh"
    source "${MDOCTOR_DIR}/lib/metadata.sh"

    # Initialize globals (used by sourced check modules)
    # shellcheck disable=SC2034
    STEP_CURRENT=0
    # shellcheck disable=SC2034
    STEP_TOTAL=1
    ACTIONS=()
    # shellcheck disable=SC2034
    WARN_COUNT=0
    # shellcheck disable=SC2034
    FAIL_COUNT=0
    # shellcheck disable=SC2034
    LOG_PATHS=()
    # shellcheck disable=SC2034
    LOG_DESCS=()
    # shellcheck disable=SC2034
    REPORT_MD=""

    init_colors

    # shellcheck source=/dev/null
    source "$check_file"

    # Map module name to function
    case "$module" in
      system)      check_system ;;
      disk)        check_disk ;;
      updates)     check_updates_basic ;;
      homebrew)    check_homebrew ;;
      node)        check_node_npm ;;
      python)      check_python ;;
      devtools)    check_dev_tools ;;
      shell)       check_shell_configs ;;
      network)     check_network ;;
      battery)     check_battery ;;
      hardware)    check_hardware ;;
      bluetooth)   check_bluetooth ;;
      usb)         check_usb ;;
      security)    check_security ;;
      startup)     check_startup ;;
      performance) check_performance ;;
      apps)        check_apps ;;
      git_config)  check_git_config ;;
      containers)  check_containers ;;
      storage)     check_storage ;;
    esac

    # Stop spinner after single-module check
    progress_stop

    # Show summary for single module
    if ((${#ACTIONS[@]} > 0)); then
      echo
      echo "${BOLD}Actions:${RESET}"
      local i=1
      for action in "${ACTIONS[@]}"; do
        echo "  ${i}. ${action}"
        i=$((i + 1))
      done
    fi
  else
    # Run full doctor
    if [ "$json_flag" = true ]; then
      JSON_ENABLED=true bash "${MDOCTOR_DIR}/doctor.sh"
    else
      bash "${MDOCTOR_DIR}/doctor.sh"
    fi
  fi
}

########################################
# COMMAND: clean
########################################

cmd_clean() {
  local force=false
  local module=""

  while [[ $# -gt 0 ]]; do
    case "$1" in
      --force|-f)
        force=true
        shift
        ;;
      --module|-m)
        module="$2"
        shift 2
        ;;
      --help|-h)
        echo "Usage: mdoctor clean [options]"
        echo
        echo "Run system cleanup. Default is dry-run mode (shows what would"
        echo "be deleted without actually removing anything)."
        echo
        echo "Options:"
        echo "  -f, --force           Actually delete files (no dry-run)"
        echo "  -m, --module <name>   Run only a specific cleanup module"
        echo "  -h, --help            Show this help"
        echo
        echo "Cleanup modules:"
        echo "  System:    trash [LOW], caches [LOW], logs [LOW], downloads [LOW],"
        echo "             crash_reports [LOW], ios_backups [LOW]"
        echo "  Software:  browser [LOW], dev [LOW], xcode [LOW], dev_caches [LOW]"
        return 0
        ;;
      *)
        error "Unknown option: $1"
        echo "Run 'mdoctor clean --help' for usage."
        return 1
        ;;
    esac
  done

  echo "${DIM}mdoctor v${MDOCTOR_VERSION_FULL}${RESET}"

  if [ -n "$module" ]; then
    # Run a single cleanup module
    local clean_file="${MDOCTOR_DIR}/cleanups/${module}.sh"
    if [ ! -f "$clean_file" ]; then
      error "Unknown cleanup module: ${module}"
      echo "Available modules: trash, caches, logs, downloads, browser, dev,"
      echo "  crash_reports, ios_backups, xcode, dev_caches"
      return 1
    fi

    # Source libraries
    source "${MDOCTOR_DIR}/lib/common.sh"
    source "${MDOCTOR_DIR}/lib/logging.sh"
    source "${MDOCTOR_DIR}/lib/disk.sh"
    source "${MDOCTOR_DIR}/lib/safety.sh"

    # Initialize progress globals for spinner
    # shellcheck disable=SC2034
    STEP_CURRENT=0
    # shellcheck disable=SC2034
    STEP_TOTAL=1
    init_colors

    # Set globals (used by sourced cleanup modules via run_cmd)
    # shellcheck disable=SC2034
    DRY_RUN=true
    LOGFILE="${HOME}/Library/Logs/macos_cleanup.log"
    # shellcheck disable=SC2034
    DAYS_OLD="${DAYS_OLD_OVERRIDE:-7}"

    if [ "$force" = true ]; then
      # shellcheck disable=SC2034
      DRY_RUN=false
    fi

    mkdir -p "$(dirname "$LOGFILE")"

    # shellcheck source=/dev/null
    source "$clean_file"

    # Start spinner for single cleanup module
    # shellcheck disable=SC2034
    STEP_CURRENT=1
    progress_start "Cleaning ${module}..."

    # Map module name to function
    case "$module" in
      trash)          clean_trash ;;
      caches)         clean_user_caches ;;
      logs)           clean_logs ;;
      downloads)      clean_downloads_large_files ;;
      browser)        clean_browser_caches ;;
      dev)            clean_dev_stuff ;;
      crash_reports)  clean_crash_reports ;;
      ios_backups)    clean_ios_backups ;;
      xcode)          clean_xcode ;;
      dev_caches)     clean_dev_caches ;;
    esac

    # Stop spinner after single-module clean
    progress_stop
  else
    # Run full cleanup
    if [ "$force" = true ]; then
      bash "${MDOCTOR_DIR}/cleanup.sh" --force
    else
      bash "${MDOCTOR_DIR}/cleanup.sh"
    fi
  fi
}

########################################
# COMMAND: fix
########################################

cmd_fix() {
  local target=""

  while [[ $# -gt 0 ]]; do
    case "$1" in
      --help|-h)
        echo "Usage: mdoctor fix [target]"
        echo
        echo "Apply common fixes for macOS issues."
        echo
        echo "Targets:"
        echo "  homebrew      [LOW]  Fix Homebrew issues (update, cleanup, doctor)"
        echo "  dns           [LOW]  Flush DNS cache"
        echo "  disk          [LOW]  Free disk space (cleanup + recommendations)"
        echo "  permissions   [MED]  Reset disk permissions and rebuild"
        echo "  spotlight     [MED]  Rebuild Spotlight index"
        echo "  bluetooth     [LOW]  Reset Bluetooth module"
        echo "  audio         [LOW]  Restart Core Audio daemon"
        echo "  wifi          [LOW]  Renew DHCP, flush DNS, cycle Wi-Fi"
        echo "  timemachine   [MED]  Verify Time Machine backup integrity"
        echo "  all           Run all fixes"
        echo
        echo "Options:"
        echo "  -h, --help    Show this help"
        return 0
        ;;
      *)
        target="$1"
        shift
        ;;
    esac
  done

  if [ -z "$target" ]; then
    echo "Usage: mdoctor fix <target>"
    echo
    echo "Available targets: homebrew, dns, disk, permissions, spotlight,"
    echo "  bluetooth, audio, wifi, timemachine, all"
    echo "Run 'mdoctor fix --help' for details."
    return 1
  fi

  # Source fix modules
  local fix_file="${MDOCTOR_DIR}/fixes/${target}.sh"

  case "$target" in
    homebrew|dns|disk|permissions|spotlight|bluetooth|audio|wifi|timemachine)
      if [ -f "$fix_file" ]; then
        # shellcheck source=/dev/null
        source "$fix_file"
        "fix_${target}"
      else
        error "Fix module not found: ${fix_file}"
        return 1
      fi
      ;;
    all)
      local t
      for t in homebrew dns disk permissions spotlight bluetooth audio wifi; do
        local f="${MDOCTOR_DIR}/fixes/${t}.sh"
        if [ -f "$f" ]; then
          # shellcheck source=/dev/null
          source "$f"
          "fix_${t}"
          echo
        fi
      done
      ;;
    *)
      error "Unknown fix target: ${target}"
      echo "Available targets: homebrew, dns, disk, permissions, spotlight,"
      echo "  bluetooth, audio, wifi, timemachine, all"
      return 1
      ;;
  esac
}

########################################
# COMMAND: info
########################################

cmd_info() {
  echo "${BOLD}${BLUE}== System Information ==${RESET}"
  echo

  local product_name product_version build arch uptime_str
  product_name=$(sw_vers -productName 2>/dev/null || echo "Unknown")
  product_version=$(sw_vers -productVersion 2>/dev/null || echo "Unknown")
  build=$(sw_vers -buildVersion 2>/dev/null || echo "Unknown")
  arch=$(uname -m 2>/dev/null || echo "Unknown")
  uptime_str=$(uptime | sed 's/.*up *//; s/, *[0-9]* user.*//')

  printf "  %-20s %s\n" "OS:" "${product_name} ${product_version} (${build})"
  printf "  %-20s %s\n" "Architecture:" "${arch}"
  printf "  %-20s %s\n" "Hostname:" "$(hostname)"
  printf "  %-20s %s\n" "Uptime:" "${uptime_str}"
  printf "  %-20s %s\n" "User:" "$(whoami)"
  printf "  %-20s %s\n" "Shell:" "${SHELL}"

  # Disk (use Data volume on macOS APFS for accurate usage)
  local disk_root="/"
  [ -d /System/Volumes/Data ] && disk_root="/System/Volumes/Data"
  local disk_info
  disk_info=$(df -h "$disk_root" | awk 'NR==2 {print $3" used / "$2" total ("$5" used)"}')
  printf "  %-20s %s\n" "Disk:" "${disk_info}"

  # Memory
  if command -v vm_stat >/dev/null 2>&1; then
    local page_size active_pages wired_pages
    page_size=$(sysctl -n hw.pagesize 2>/dev/null || echo 4096)
    active_pages=$(vm_stat | awk '/Pages active/ {gsub("\\.","",$3); print $3}')
    wired_pages=$(vm_stat | awk '/Pages wired down/ {gsub("\\.","",$4); print $4}')

    local total_mem
    total_mem=$(sysctl -n hw.memsize 2>/dev/null || echo 0)
    local total_gb
    total_gb=$(awk -v m="$total_mem" 'BEGIN {printf "%.0f", m/1073741824}')
    local used_kb
    used_kb=$(( (active_pages + wired_pages) * page_size / 1024 ))
    local used_gb
    used_gb=$(awk -v kb="$used_kb" 'BEGIN {printf "%.1f", kb/1048576}')

    printf "  %-20s %s\n" "Memory:" "${used_gb} GB used / ${total_gb} GB total"
  fi

  # CPU
  local cpu_brand
  cpu_brand=$(sysctl -n machdep.cpu.brand_string 2>/dev/null || echo "Unknown")
  printf "  %-20s %s\n" "CPU:" "${cpu_brand}"

  # Load
  local load
  load=$(sysctl -n vm.loadavg 2>/dev/null | awk '{print $2", "$3", "$4}')
  printf "  %-20s %s\n" "Load (1/5/15m):" "${load}"

  # Key tools
  echo
  echo "${BOLD}  Installed Tools:${RESET}"
  local tools=("brew" "git" "node" "npm" "python3" "pip3" "docker" "code" "java")
  for tool in "${tools[@]}"; do
    if command -v "$tool" >/dev/null 2>&1; then
      local ver
      case "$tool" in
        brew)    ver=$(brew --version 2>/dev/null | head -n1) ;;
        git)     ver=$(git --version 2>/dev/null) ;;
        node)    ver=$(node -v 2>/dev/null) ;;
        npm)     ver=$(npm -v 2>/dev/null) ;;
        python3) ver=$(python3 --version 2>/dev/null) ;;
        pip3)    ver=$(pip3 --version 2>/dev/null | awk '{print $2}') ;;
        docker)  ver=$(docker --version 2>/dev/null) ;;
        code)    ver=$(code --version 2>/dev/null | head -n1) ;;
        java)    ver=$(java -version 2>&1 | head -n1) ;;
        *)       ver="installed" ;;
      esac
      printf "    ${GREEN}%-12s${RESET} %s\n" "${tool}" "${ver}"
    fi
  done
  echo
}

########################################
# COMMAND: list
########################################

cmd_list() {
  source "${MDOCTOR_DIR}/lib/metadata.sh"

  # Register all modules for listing
  # Check modules — Hardware
  register_module check battery    Hardware SAFE check_battery     "Battery health, cycle count, capacity"
  register_module check hardware   Hardware SAFE check_hardware    "CPU, RAM, model, thermals"
  register_module check bluetooth  Hardware SAFE check_bluetooth   "Bluetooth power state & devices"
  register_module check usb        Hardware SAFE check_usb         "Connected USB devices"
  # Check modules — System
  register_module check system      System SAFE check_system        "OS version, memory, load average"
  register_module check disk        System SAFE check_disk          "Disk usage & health"
  register_module check updates     System SAFE check_updates_basic "macOS updates & Spotlight"
  register_module check security    System SAFE check_security      "Firewall, FileVault, SIP, Gatekeeper"
  register_module check startup     System SAFE check_startup       "Launch agents, daemons, login items"
  register_module check network     System SAFE check_network       "Connectivity, DNS, Wi-Fi signal"
  register_module check performance System SAFE check_performance   "Memory pressure, CPU, processes"
  register_module check storage     System SAFE check_storage       "Large files & app storage analysis"
  # Check modules — Software
  register_module check homebrew   Software SAFE check_homebrew    "Homebrew installation & packages"
  register_module check node       Software SAFE check_node_npm    "Node.js & npm"
  register_module check python     Software SAFE check_python      "Python & pip"
  register_module check devtools   Software SAFE check_dev_tools   "Xcode CLT, Git, Docker"
  register_module check shell      Software SAFE check_shell_configs "Shell config syntax"
  register_module check apps       Software SAFE check_apps        "Crash reports, application health"
  register_module check git_config Software SAFE check_git_config  "Git & SSH configuration"
  register_module check containers Software SAFE check_containers  "Docker & container health"

  # Cleanup modules
  register_module cleanup trash         System   LOW clean_trash               "Empty Trash"
  register_module cleanup caches        System   LOW clean_user_caches         "User cache directories"
  register_module cleanup logs          System   LOW clean_logs                "Old log files"
  register_module cleanup downloads     System   LOW clean_downloads_large_files "Large files in Downloads"
  register_module cleanup crash_reports System   LOW clean_crash_reports       "Old crash/diagnostic reports"
  register_module cleanup ios_backups   System   LOW clean_ios_backups         "Old iOS device backups"
  register_module cleanup browser       Software LOW clean_browser_caches      "Browser cache cleanup"
  register_module cleanup dev           Software LOW clean_dev_stuff           "Developer tool caches"
  register_module cleanup xcode         Software LOW clean_xcode              "Xcode DerivedData, archives, simulators"
  register_module cleanup dev_caches    Software LOW clean_dev_caches         "Developer dependency & package caches"

  # Fix modules
  register_module fix homebrew    Software LOW  fix_homebrew    "Update, upgrade, cleanup Homebrew"
  register_module fix dns         System   LOW  fix_dns         "Flush DNS cache"
  register_module fix disk        System   LOW  fix_disk        "Free disk space"
  register_module fix permissions System   MED  fix_permissions "Reset file permissions"
  register_module fix spotlight   System   MED  fix_spotlight   "Rebuild Spotlight index"
  register_module fix bluetooth   Hardware LOW  fix_bluetooth   "Reset Bluetooth module"
  register_module fix audio       System   LOW  fix_audio       "Restart Core Audio daemon"
  register_module fix wifi        System   LOW  fix_wifi        "Renew DHCP, flush DNS, cycle Wi-Fi"
  register_module fix timemachine System   MED  fix_timemachine "Verify Time Machine backups"

  echo "${BOLD}${BLUE}== All Modules ==${RESET}"
  echo

  echo "${BOLD}Check Modules (21 — all read-only):${RESET}"
  list_modules_by_category check
  echo

  echo "${BOLD}Cleanup Modules (10):${RESET}"
  list_modules_by_category cleanup
  echo

  echo "${BOLD}Fix Targets (9):${RESET}"
  list_modules_by_category fix
  echo
}

########################################
# COMMAND: history
########################################

cmd_history() {
  source "${MDOCTOR_DIR}/lib/history.sh"

  echo "${BOLD}${BLUE}== Health Score History ==${RESET}"
  echo
  history_show "${1:-10}"
}

########################################
# COMMAND: benchmark
########################################

cmd_benchmark() {
  source "${MDOCTOR_DIR}/lib/benchmark.sh"
  run_benchmark
}

########################################
# COMMAND: version
########################################

cmd_version() {
  echo "mdoctor ${MDOCTOR_VERSION_FULL}"
}

########################################
# COMMAND: help
########################################

cmd_help() {
  banner
  echo "Usage: ${BOLD}mdoctor${RESET} <command> [options]"
  echo
  echo "${BOLD}Commands:${RESET}"
  printf "  ${GREEN}%-12s${RESET} %s\n" "check"     "Run system health audit (read-only, 21 checks)"
  printf "  ${GREEN}%-12s${RESET} %s\n" "clean"     "Run system cleanup (dry-run by default, 10 modules)"
  printf "  ${GREEN}%-12s${RESET} %s\n" "fix"       "Apply common fixes (9 targets)"
  printf "  ${GREEN}%-12s${RESET} %s\n" "info"      "Show system information summary"
  printf "  ${GREEN}%-12s${RESET} %s\n" "list"      "List all modules with category & risk level"
  printf "  ${GREEN}%-12s${RESET} %s\n" "history"   "View health score trends over time"
  printf "  ${GREEN}%-12s${RESET} %s\n" "benchmark" "Run disk, network, CPU benchmarks"
  printf "  ${GREEN}%-12s${RESET} %s\n" "version"   "Show mdoctor version"
  printf "  ${GREEN}%-12s${RESET} %s\n" "help"      "Show this help message"
  echo
  echo "${BOLD}Check Modules${RESET} (all [SAFE] read-only):"
  echo "  Hardware:  battery, hardware, bluetooth, usb"
  echo "  System:    system, disk, updates, security, startup, network, performance, storage"
  echo "  Software:  homebrew, node, python, devtools, shell, apps, git_config, containers"
  echo
  echo "${BOLD}Cleanup Modules${RESET} (all [LOW] risk):"
  echo "  System:    trash, caches, logs, downloads, crash_reports, ios_backups"
  echo "  Software:  browser, dev, xcode, dev_caches"
  echo
  echo "${BOLD}Fix Targets${RESET}:"
  echo "  [LOW]  homebrew, dns, disk, bluetooth, audio, wifi"
  echo "  [MED]  permissions, spotlight, timemachine"
  echo
  echo "${BOLD}Examples:${RESET}"
  echo "  mdoctor check                    # Full health audit (21 checks)"
  echo "  mdoctor check -m battery         # Check only battery health"
  echo "  mdoctor check --json             # JSON output for automation"
  echo "  mdoctor clean                    # Dry-run cleanup"
  echo "  mdoctor clean --force            # Actually clean up"
  echo "  mdoctor clean -m crash_reports   # Clean only crash reports"
  echo "  mdoctor fix homebrew             # Fix Homebrew issues"
  echo "  mdoctor fix wifi                 # Fix Wi-Fi connection"
  echo "  mdoctor fix all                  # Run all fixes"
  echo "  mdoctor list                     # Show all modules"
  echo "  mdoctor history                  # View score trends"
  echo "  mdoctor benchmark                # Run speed tests"
  echo "  mdoctor info                     # Quick system overview"
  echo
  echo "${BOLD}Environment Variables:${RESET}"
  echo "  DAYS_OLD_OVERRIDE=N              Override cleanup age threshold (default: 7)"
  echo
  echo "${DIM}Documentation: https://github.com/luongnv89/mdoctor${RESET}"
}

########################################
# MAIN DISPATCH
########################################

main() {
  local command="${1:-}"
  shift 2>/dev/null || true

  case "$command" in
    check)     cmd_check "$@" ;;
    clean)     cmd_clean "$@" ;;
    fix)       cmd_fix "$@" ;;
    info)      cmd_info ;;
    list)      cmd_list ;;
    history)   cmd_history "$@" ;;
    benchmark) cmd_benchmark ;;
    version)   cmd_version ;;
    -v|--version) cmd_version ;;
    help|-h|--help) cmd_help ;;
    "")        cmd_help ;;
    *)
      error "Unknown command: ${command}"
      echo "Run 'mdoctor help' for usage."
      return 1
      ;;
  esac
}

main "$@"
